% ------------------------------------------------------------------------------------------------- %
%								dndtraps.sty  	Marcel Zauder 02/04/2023						%
% Stylesheet by Marcel                                                                              %
% ------------------------------------------------------------------------------------------------- %
% ################################################################################################# %
% ------------------------------------------- Variables ------------------------------------------- %

\ExplSyntaxOn
% ------------------------------------------------------------------------------------------------- %
% ################################################################################################# %
% ------------------------------------ Quest Hooks  Background ------------------------------------ %
\DeclareTColorBox {DndTrapBg} { O{} m }
  {
    enhanced,
    frame~hidden,
    before~skip      = 12pt plus 3pt minus 3pt,
    boxrule          = 0pt,
    breakable,
    parbox           = false,
    boxsep           = 2pt,
    toptitle         = 8pt,
    top              = 0pt,
    left             = 2pt,
    right            = 2pt,
    bottom           = 7pt,
    sharp~corners,
    oversize         = 0pt,
    borderline~north = {3pt} {0pt}   {black},
    borderline~north = {2pt} {0.5pt} {rulered},
    borderline~south = {3pt} {0pt}   {black},
    borderline~south = {2pt} {0.5pt} {rulered},
    colback          = lightgray,
    colbacktitle     = lightgray,
    colframe         = titlered,
    fonttitle        = \DndFontTrapTitle,
    coltitle         = titlered,
    fontupper        = \DndFontStatBlockBody,
    fontlower        = \DndFontStatBlockBody,
    title            = {#2},
    #1
  }
% ------------------------------------------------------------------------------------------------- %
% ################################################################################################# %
% -------------------------------- Quest Hooks Background Handling -------------------------------- %
\bool_if:NTF \l__dnd_show_background_bool
  {
    \let\DndTrap\DndTrapBg
    \let\endDndTrap\endDndTrapBg
  }{
    \let\DndTrap\DndTrapNoBg
    \let\endDndTrap\endDndTrapNoBg
  }
% ------------------------------------------------------------------------------------------------- %
% ################################################################################################# %
% ---------------------------------------- Quest Hook Line ---------------------------------------- %
\NewDocumentCommand {\DndTrapLine} {}
  {
    \par \vspace{-2pt} \noindent
    \begin {tikzpicture}
      \draw [ rulered, fill = rulered ] ( 0, 0 ) -- ( 0, 0.1 ) -- ( \linewidth, 0.05 );
    \end {tikzpicture}
    \par
  }
% ------------------------------------------------------------------------------------------------- %
% ################################################################################################# %
% ------------------------------------------ Trap Basics ------------------------------------------ %
\newlist {__dnd_trap_attributes} {description} {1}
\setlist [__dnd_trap_attributes]
  {
    font     = \entryfont,
    labelsep = \l__dnd_space_dim,
    nosep,
  }

% Only prints the item label if the value was supplied
\cs_new_protected_nopar:Npn \__dnd_if_trap_attribute:nn #1#2
  {
    \tl_if_empty:NF {#1}
      { \item [#2] #1 }
  }

%% Trap basics
\keys_define:nn { dnd / trap / basics }
  {
  	save_dc		.tl_set:N			= \l__save_dc_tl,
  	save_dc		.initial:n			= 10,
  	save_dc		.value_required:n	= true,
  	skill		.tl_set:N			= \l__skill_tl,
  	skill		.initial:n			= Dexterity,
  	skill		.value_required:n	= true,
  	damage_value	.tl_set:N			= \l__damage_value_tl,
  	damage_value	.initial:n			= 0,
  	damage_value	.value_required:n	= false,
  	damage_type	.tl_set:N			= \l__damage_type_tl,
  	damage_type	.initial:n			= {Damage Type},
	damage_type	.value_required:n	= false,
  }

\cs_new_protected_nopar:Npn \__dnd_trap_basics:
  {
      \begin {__dnd_quest_attributes}
        \item [DC] \entryfont\l__save_dc_tl
        \item [Skill] \entryfont\l__skill_tl
        \item [Damage] \entryfont\l__damage_value_tl\ \l__damage_type_tl
      \end {__dnd_quest_attributes}
  }

\NewDocumentCommand {\DndTrapBasics} {o}
  {
    \group_begin:
      \keys_set:nn { dnd / trap / basics } {#1}
      \DndTrapLine
      \__dnd_trap_basics:
      \DndTrapLine
    \group_end:
  }
\ExplSyntaxOff % Switch-Off Kernel Mode